From 2996708787bb5ce91d355d29f4fff9a017a74d39 Mon Sep 17 00:00:00 2001
From: Rajab Natshah <33889-RajabNatshah@users.noreply.drupalcode.org>
Date: Mon, 14 Jul 2025 17:40:44 +0000
Subject: [PATCH 1/3] Issue #3535875: Add Navigation Top Bar integration for
 Tour module in Drupal ~11.2.0 with Gin admin theme

---
 src/Plugin/TopBarItem/TourTopBarItem.php | 142 +++++++++++++++++++++++
 1 file changed, 142 insertions(+)
 create mode 100644 src/Plugin/TopBarItem/TourTopBarItem.php

diff --git a/src/Plugin/TopBarItem/TourTopBarItem.php b/src/Plugin/TopBarItem/TourTopBarItem.php
new file mode 100644
index 0000000..8a3be88
--- /dev/null
+++ b/src/Plugin/TopBarItem/TourTopBarItem.php
@@ -0,0 +1,142 @@
+<?php
+
+declare(strict_types=1);
+
+namespace Drupal\tour\Plugin\TopBarItem;
+
+use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
+use Drupal\Core\Session\AccountProxyInterface;
+use Drupal\Core\StringTranslation\StringTranslationTrait;
+use Drupal\Core\StringTranslation\TranslatableMarkup;
+use Drupal\navigation\Attribute\TopBarItem;
+use Drupal\navigation\TopBarItemBase;
+use Drupal\navigation\TopBarRegion;
+use Symfony\Component\DependencyInjection\ContainerInterface;
+use Drupal\tour\TourHelper;
+
+/**
+ * Provides the tour top bar item.
+ */
+#[TopBarItem(
+  id: 'tour_topbar',
+  region: TopBarRegion::Tools,
+  label: new TranslatableMarkup('tour'),
+)]
+class TourTopBarItem extends TopBarItemBase implements ContainerFactoryPluginInterface {
+
+  use StringTranslationTrait;
+
+  /**
+   * Constructs a new TourTopBarItem instance.
+   *
+   * @param array $configuration
+   *   A configuration array containing plugin instance information.
+   * @param string $plugin_id
+   *   The plugin ID for the plugin instance.
+   * @param mixed $plugin_definition
+   *   The plugin implementation definition.
+   * @param \Drupal\Core\Session\AccountProxyInterface $currentUser
+   *   The current user.
+   * @param mixed $tourHelper
+   *   Helper methods for the tour module.
+   */
+  public function __construct(
+    array $configuration,
+    string $plugin_id,
+    $plugin_definition,
+    protected AccountProxyInterface $currentUser,
+    protected TourHelper $tourHelper,
+  ) {
+    parent::__construct($configuration, $plugin_id, $plugin_definition);
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition): static {
+    return new static(
+      $configuration,
+      $plugin_id,
+      $plugin_definition,
+      $container->get('current_user'),
+      $container->get('tour.helper'),
+    );
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function build(): array {
+    $build = [
+      '#cache' => [
+        'contexts' => ['url'],
+        'tags' => ['tour_settings'],
+      ],
+    ];
+    // Check if the user has the required permission.
+    if (!$this->currentUser->hasPermission('access tour')) {
+      return $build;
+    }
+
+    return $this->buildTourNavigation();
+
+    return $build;
+  }
+
+  /**
+   * Builds the tour navigation render array.
+   *
+   * @param array $cache_contexts
+   *   The cache contexts.
+   *
+   * @return array
+   *   A render array for the tour navigation.
+   */
+  protected function buildTourNavigation(): array {
+    $tour_helper = $this->tourHelper;
+    $results = $tour_helper->loadTourEntities();
+    $no_tips = empty($results);
+
+    if ($this->tourHelper->shouldEmptyBeHidden($no_tips)) {
+      return [
+        '#cache' => [
+          'contexts' => ['url'],
+          'tags' => ['tour_settings'],
+        ],
+      ];
+    }
+
+    $tour_avail_text = $tour_helper->getTourLabels()['tour_avail_text'];
+    $tour_no_avail_text = $tour_helper->getTourLabels()['tour_no_avail_text'];
+
+    $classes = [
+      'js-tour-start-button',
+      'toolbar-button',
+      'toolbar-button--icon--help',
+    ];
+
+    if ($no_tips) {
+      $classes = array_merge($classes, ['toolbar-tab-empty']);
+    }
+
+    return [
+      'content' => [
+        '#theme' => 'button',
+        '#type' => 'html_tag',
+        '#tag' => 'button',
+        '#cache' => [
+          'contexts' => ['url'],
+          'tags' => ['tour_settings'],
+        ],
+        '#value' => $no_tips ? $tour_no_avail_text : $tour_avail_text,
+        '#attributes' => [
+          'class' => $classes,
+          'aria-haspopup' => 'dialog',
+          'type' => 'button',
+          'aria-disabled' => $no_tips ? 'true' : 'false',
+        ],
+      ]
+    ];
+  }
+
+}
-- 
GitLab


From d01feae0bf5f3ad7cda20ebac4421ac2e62174dd Mon Sep 17 00:00:00 2001
From: Rajab Natshah <33889-RajabNatshah@users.noreply.drupalcode.org>
Date: Thu, 17 Jul 2025 13:34:00 +0000
Subject: [PATCH 2/3] Add the Help Icon and moved to teh Top Bar Actions region

---
 src/Plugin/TopBarItem/TourTopBarItem.php | 37 ++++++++++++++----------
 1 file changed, 21 insertions(+), 16 deletions(-)

diff --git a/src/Plugin/TopBarItem/TourTopBarItem.php b/src/Plugin/TopBarItem/TourTopBarItem.php
index 8a3be88..1ccb72d 100644
--- a/src/Plugin/TopBarItem/TourTopBarItem.php
+++ b/src/Plugin/TopBarItem/TourTopBarItem.php
@@ -13,13 +13,14 @@ use Drupal\navigation\TopBarItemBase;
 use Drupal\navigation\TopBarRegion;
 use Symfony\Component\DependencyInjection\ContainerInterface;
 use Drupal\tour\TourHelper;
+use Drupal\Core\Template\Attribute;
 
 /**
  * Provides the tour top bar item.
  */
 #[TopBarItem(
   id: 'tour_topbar',
-  region: TopBarRegion::Tools,
+  region: TopBarRegion::Actions,
   label: new TranslatableMarkup('tour'),
 )]
 class TourTopBarItem extends TopBarItemBase implements ContainerFactoryPluginInterface {
@@ -120,22 +121,26 @@ class TourTopBarItem extends TopBarItemBase implements ContainerFactoryPluginInt
     }
 
     return [
-      'content' => [
-        '#theme' => 'button',
-        '#type' => 'html_tag',
-        '#tag' => 'button',
-        '#cache' => [
-          'contexts' => ['url'],
-          'tags' => ['tour_settings'],
-        ],
-        '#value' => $no_tips ? $tour_no_avail_text : $tour_avail_text,
-        '#attributes' => [
-          'class' => $classes,
+      '#type' => 'component',
+      '#component' => 'navigation:toolbar-button',
+      '#props' => [
+        'text' =>  $no_tips ? $tour_no_avail_text : $tour_avail_text,
+        'modifiers' => ['small-offset'],
+        'icon' => ['icon_id' => 'help'],
+        'html_tag' => 'button',
+        'content' => $no_tips ? $tour_no_avail_text : $tour_avail_text,
+        'attributes' => new Attribute([
+          'href' => '',
           'aria-haspopup' => 'dialog',
-          'type' => 'button',
-          'aria-disabled' => $no_tips ? 'true' : 'false',
-        ],
-      ]
+          'aria-disabled' => $no_tips ? 'true' : 'false'
+        ]),
+        'extra_classes' => $classes
+      ],
+      '#cache' => [
+        'contexts' => ['url'],
+        'tags' => ['tour_settings'],
+      ],
+      '#weight' => -2000,
     ];
   }
 
-- 
GitLab


From bcbb1bcac387cc1445236d2bad234430269d3829 Mon Sep 17 00:00:00 2001
From: Rajab Natshah <33889-RajabNatshah@users.noreply.drupalcode.org>
Date: Sun, 27 Jul 2025 16:48:04 +0000
Subject: [PATCH 3/3] Move to Bop Bar Tools region and remove the weight

---
 src/Plugin/TopBarItem/TourTopBarItem.php | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/Plugin/TopBarItem/TourTopBarItem.php b/src/Plugin/TopBarItem/TourTopBarItem.php
index 1ccb72d..27aadc5 100644
--- a/src/Plugin/TopBarItem/TourTopBarItem.php
+++ b/src/Plugin/TopBarItem/TourTopBarItem.php
@@ -20,7 +20,7 @@ use Drupal\Core\Template\Attribute;
  */
 #[TopBarItem(
   id: 'tour_topbar',
-  region: TopBarRegion::Actions,
+  region: TopBarRegion::Tools,
   label: new TranslatableMarkup('tour'),
 )]
 class TourTopBarItem extends TopBarItemBase implements ContainerFactoryPluginInterface {
@@ -140,7 +140,6 @@ class TourTopBarItem extends TopBarItemBase implements ContainerFactoryPluginInt
         'contexts' => ['url'],
         'tags' => ['tour_settings'],
       ],
-      '#weight' => -2000,
     ];
   }
 
-- 
GitLab

